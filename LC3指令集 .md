# LC3 指令用法查阅文档（完整版）
## 一、指令分类总览
LC3 共有 16 条核心指令，按功能分为 5 类：数据处理类、内存访问类、控制转移类、输入输出类、陷阱指令类。所有指令均为 16 位二进制编码，操作数支持寄存器、立即数、内存地址等形式，以下按分类详细说明用法。

---

## 二、数据处理类指令（4 条）
### 1. ADD（加法指令）
- **功能**：将两个操作数相加，结果存入目标寄存器。
- **格式**：`ADD DR, SR1, SR2` 或 `ADD DR, SR1, imm5`
  - DR：目标寄存器（R0-R7），存储运算结果
  - SR1：源寄存器 1（R0-R7），第一个加数
  - SR2：源寄存器 2（R0-R7），第二个加数（寄存器模式）
  - imm5：5 位立即数（-16~+15），第二个加数（立即数模式）
- **示例**：
  - `ADD R2, R0, R1` → R2 = R0 + R1（寄存器模式）
  - `ADD R3, R2, #5` → R3 = R2 + 5（立即数模式，#表示十进制）
- **注意**：立即数需在 -16~+15 范围内，超出会编译报错。

### 2. AND（按位与指令）
- **功能**：对两个操作数进行按位与运算，结果存入目标寄存器。
- **格式**：`AND DR, SR1, SR2` 或 `AND DR, SR1, imm5`
  - 参数含义同 ADD 指令
- **示例**：
  - `AND R1, R0, R2` → R1 = R0 & R2（按位与）
  - `AND R4, R3, #3` → R4 = R3 & 3（立即数按位与，保留低 2 位）
- **常用场景**：数据位掩码、清零（如 `AND R0, R0, #0` 可将 R0 清零）。

### 3. NOT（按位非指令）
- **功能**：对源寄存器的值进行按位取反，结果存入目标寄存器。
- **格式**：`NOT DR, SR`
  - DR：目标寄存器（R0-R7）
  - SR：源寄存器（R0-R7）
- **示例**：`NOT R1, R0` → R1 = ~R0（按位取反，二进制每一位 0 变 1、1 变 0）
- **注意**：无立即数模式，仅支持寄存器操作。

### 4. XOR（异或指令，扩展指令）
- **功能**：对两个操作数进行按位异或运算，结果存入目标寄存器。
- **格式**：`XOR DR, SR1, SR2`
  - 参数含义同 ADD 指令
- **示例**：`XOR R2, R0, R1` → R2 = R0 ^ R1（按位异或，相同为 0、不同为 1）
- **常用场景**：数据加密、奇偶校验。

---

## 三、内存访问类指令（5 条）
### 1. LD（加载指令）
- **功能**：从内存的 PC 相对地址中读取数据，存入目标寄存器。
- **格式**：`LD DR, label`
  - DR：目标寄存器（R0-R7）
  - label：符号标签，对应 9 位偏移量（-256~+255，相对于当前 PC 值）
- **示例**：`LD R0, NUM` → 从 NUM 标签对应的内存地址中读取数据，存入 R0
- **原理**：实际地址 = PC + 1 + 偏移量（标签会被汇编器转换为 9 位偏移量）。

### 2. LDI（间接加载指令）
- **功能**：通过内存中的地址间接读取数据（两次访存），存入目标寄存器。
- **格式**：`LDI DR, label`
  - 参数含义同 LD 指令
- **示例**：`LDI R1, PTR` → 先读取 PTR 地址中的值（作为间接地址），再从该间接地址读取数据存入 R1
- **注意**：间接地址需指向合法内存区域（x0000~xFFFF），否则会触发内存错误。

### 3. LDR（基址加载指令）
- **功能**：以源寄存器的值为基地址，加上偏移量，从计算出的内存地址读取数据存入目标寄存器。
- **格式**：`LDR DR, SR, imm6`
  - DR：目标寄存器（R0-R7）
  - SR：基址寄存器（R0-R7）
  - imm6：6 位偏移量（-32~+31）
- **示例**：`LDR R2, R3, #4` → 内存地址 = R3 + 4，读取该地址数据存入 R2
- **常用场景**：数组访问、结构体成员读取。

### 4. ST（存储指令）
- **功能**：将目标寄存器中的数据写入内存的 PC 相对地址。
- **格式**：`ST SR, label`
  - SR：源寄存器（R0-R7），存储要写入的数据
  - label：符号标签，对应 9 位偏移量（-256~+255）
- **示例**：`ST R0, NUM` → 将 R0 中的数据写入 NUM 标签对应的内存地址。

### 5. STR（基址存储指令）
- **功能**：以源寄存器的值为基地址，加上偏移量，将目标寄存器的数据写入计算出的内存地址。
- **格式**：`STR SR, BaseR, imm6`
  - SR：源寄存器（R0-R7），存储要写入的数据
  - BaseR：基址寄存器（R0-R7）
  - imm6：6 位偏移量（-32~+31）
- **示例**：`STR R1, R2, #-2` → 内存地址 = R2 - 2，将 R1 数据写入该地址。

---

## 四、控制转移类指令（4 条）
### 1. BR（分支指令）
- **功能**：根据条件标志位（N、Z、P）判断是否跳转到目标标签。
- **格式**：`BR[condition] label`
  - condition：条件组合（N：负标志、Z：零标志、P：正标志），可组合使用（如 BRNZ、BRZP）
  - label：目标标签，对应 9 位偏移量（-256~+255）
- **条件说明**：
  - BRN：N=1 时跳转（结果为负）
  - BRZ：Z=1 时跳转（结果为零）
  - BRP：P=1 时跳转（结果为正）
  - BRNZ：N=1 或 Z=1 时跳转（结果非正）
  - BRNZP：无条件跳转（忽略标志位）
- **示例**：`BRZ END` → 若 Z 标志为 1（上一条指令结果为零），跳转到 END 标签。

### 2. JMP（跳转指令）
- **功能**：无条件跳转到源寄存器中存储的地址（寄存器间接寻址）。
- **格式**：`JMP BaseR`
  - BaseR：基址寄存器（R0-R7），存储目标地址
- **示例**：`JMP R3` → 程序跳转到 R3 中存储的内存地址继续执行
- **常用场景**：函数调用返回、动态跳转。

### 3. JSR（跳转并保存返回地址指令）
- **功能**：无条件跳转到目标地址，同时将返回地址（PC+1）存入 R7。
- **格式**：`JSR label` 或 `JSRR BaseR`
  - label：目标标签，对应 11 位偏移量（-1024~+1023）（JSR 模式）
  - BaseR：基址寄存器（R0-R7），存储目标地址（JSRR 模式，寄存器间接跳转）
- **示例**：
  - `JSR SUB` → 跳转到 SUB 子程序，返回地址存入 R7
  - `JSRR R2` → 跳转到 R2 存储的地址，返回地址存入 R7
- **注意**：R7 用于保存返回地址，子程序中不可随意修改 R7（如需修改需先备份）。

### 4. RET（返回指令）
- **功能**：从子程序返回，跳转至 R7 中存储的返回地址。
- **格式**：`RET`（无参数）
- **示例**：子程序末尾执行 `RET` → 跳回调用者的下一条指令
- **本质**：`RET` 等价于 `JMP R7`，是 JMP 指令的简化形式。

---

## 五、输入输出类指令（2 条）
### 1. IN（输入指令）
- **功能**：从键盘读取一个字符（ASCII 码），存入目标寄存器，同时设置标志位。
- **格式**：`IN DR`
  - DR：目标寄存器（R0-R7），存储读取的 ASCII 码
- **示例**：`IN R0` → 读取键盘输入的字符，ASCII 码存入 R0
- **注意**：输入时需按下回车键确认，若输入非打印字符，寄存器存储对应 ASCII 码。

### 2. OUT（输出指令）
- **功能**：将目标寄存器中的 ASCII 码对应的字符输出到屏幕。
- **格式**：`OUT SR`
  - SR：源寄存器（R0-R7），存储要输出的 ASCII 码
- **示例**：`OUT R1` → 将 R1 中 ASCII 码对应的字符显示在屏幕上
- **常用场景**：字符串输出（需循环读取字符串每个字符并执行 OUT）。

---

## 六、陷阱指令类（1 条）
### TRAP（陷阱指令）
- **功能**：触发系统调用，执行预设的系统服务（如终止程序、字符串输入输出等）。
- **格式**：`TRAP trapvect8`
  - trapvect8：8 位陷阱向量（0x00~0xFF），对应不同系统服务
- **常用陷阱向量及功能**：
  - `TRAP x20`（GETC）：读取一个字符（无回显），存入 R0
  - `TRAP x21`（OUT）：输出 R0 中的 ASCII 字符（同 OUT 指令）
  - `TRAP x22`（PUTS）：输出 R0 指向的字符串（字符串以 x00 结尾）
  - `TRAP x23`（IN）：读取字符并回显（同 IN 指令）
  - `TRAP x25`（HALT）：终止程序运行
- **示例**：`TRAP x25` → 终止程序，等同于 `HALT`。

---

## 七、使用注意事项
1. 寄存器限制：所有指令的寄存器操作数仅支持 R0-R7，不可超出范围。
2. 地址范围：PC 相对地址偏移量（LD、ST、BR 等）需在对应位数限制内，否则汇编报错。
3. 标志位影响：ADD、AND、NOT、IN 等指令会更新 N（负）、Z（零）、P（正）标志位，BR 指令依赖这些标志位判断跳转。
4. 陷阱指令：常用陷阱向量（如 x20~x25）无需自定义，直接调用即可，其他向量需结合系统配置使用。

---

要不要我帮你生成一份 **PDF 格式的离线查阅文档**，或补充指令编码格式、常见错误排查等扩展内容？